<?xml version="1.0" encoding="utf-8"?>
<Project>
  <PropertyGroup>
    <MSBuildWarningsAsMessages>MSB4181</MSBuildWarningsAsMessages>
  </PropertyGroup>

  <Target Name="CaravelaCompilerSetAnalyzerAssembliesInPackage" DependsOnTargets="ResolveReferences;BuiltProjectOutputGroup" Condition="$(IsPackable) == 'true'">
    <ItemGroup>
      <!-- include assemblies from the current project -->
      <None Include="@(BuiltProjectOutputGroupOutput)" Pack="true" PackagePath="analyzers/dotnet/cs" Visible="false"/>
      <!-- include assemblies from references -->
      <None Include="@(ReferenceCopyLocalPaths->WithMetadataValue('ReferenceSourceTarget', 'ProjectReference'))" Pack="true" PackagePath="analyzers/dotnet/cs" Visible="false"/>
    </ItemGroup>
  </Target>

  <!-- based on https://stackoverflow.com/a/56018426/41071 -->
  <PropertyGroup>
    <TargetsForTfmSpecificBuildOutput>$(TargetsForTfmSpecificBuildOutput);CaravelaCompilerSetLibAssembliesInPackage</TargetsForTfmSpecificBuildOutput>
  </PropertyGroup>

  <Target Name="CaravelaCompilerSetLibAssembliesInPackage" DependsOnTargets="ResolveReferences" Condition="$(IsPackable) == 'true'">
    <ItemGroup>
      <!-- include assemblies from references -->
      <BuildOutputInPackage Include="@(ReferenceCopyLocalPaths->WithMetadataValue('ReferenceSourceTarget', 'ProjectReference'))"/>
      <!-- exclude assemblies from the current project -->
      <BuiltProjectOutputGroupOutput Remove="@(BuiltProjectOutputGroupOutput)"/>
    </ItemGroup>
  </Target>

  <UsingTask TaskName="CaravelaCompilerRewriteNuspec" TaskFactory="RoslynCodeTaskFactory" AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll">
    <ParameterGroup>
      <NuspecFile/>
    </ParameterGroup>
    <Task>
      <Using Namespace="System.Xml.Linq"/>
      <Code Type="Fragment" Language="cs">
        <![CDATA[
            XNamespace ns = "http://schemas.microsoft.com/packaging/2012/06/nuspec.xsd";

            var doc = XDocument.Load(NuspecFile);
            var groups = doc.Element(ns + "package").Element(ns + "metadata").Element(ns + "dependencies").Elements(ns + "group");

            foreach (var group in groups)
            {
                var caravelaDependency = group.Elements(ns + "dependency").SingleOrDefault(e => e.Attribute("id").Value == "Caravela.Compiler.Sdk");

                if (caravelaDependency != null)
                {
                    caravelaDependency.Attribute("id").Value = "Caravela.Compiler";
                    caravelaDependency.Attribute("exclude")?.Remove();
                }
            }

            doc.Save(NuspecFile);
        ]]>
      </Code>
    </Task>
  </UsingTask>

  <!-- based on https://github.com/NuGet/NuGet.Client/blob/1f3a4d9/src/NuGet.Core/NuGet.Build.Tasks.Pack/NuGet.Build.Tasks.Pack.targets#L195 -->
  <Target Name="CaravelaCompilerGenerateNuspec"
          DependsOnTargets="$(GenerateNuspecDependsOn);_CalculateInputsOutputsForPack;_GetProjectReferenceVersions;_InitializeNuspecRepositoryInformationProperties"
          Condition="$(IsPackable) == 'true'" Inputs="@(NuGetPackInput)" Outputs="@(NuGetPackOutput)">
    <PackTask PackItem="$(PackProjectInputFile)"
              PackageFiles="@(_PackageFiles)"
              PackageFilesToExclude="@(_PackageFilesToExclude)"
              PackageVersion="$(PackageVersion)"
              PackageId="$(PackageId)"
              Title="$(Title)"
              Authors="$(Authors)"
              Description="$(PackageDescription)"
              Copyright="$(Copyright)"
              RequireLicenseAcceptance="$(PackageRequireLicenseAcceptance)"
              LicenseUrl="$(PackageLicenseUrl)"
              ProjectUrl="$(PackageProjectUrl)"
              IconUrl="$(PackageIconUrl)"
              ReleaseNotes="$(PackageReleaseNotes)"
              Tags="$(PackageTags)"
              DevelopmentDependency="$(DevelopmentDependency)"
              BuildOutputInPackage="@(_BuildOutputInPackage)"
              ProjectReferencesWithVersions="@(_ProjectReferencesWithVersions)"
              TargetPathsToSymbols="@(_TargetPathsToSymbols)"
              TargetFrameworks="@(_TargetFrameworks)"
              FrameworksWithSuppressedDependencies="@(_FrameworksWithSuppressedDependencies)"
              AssemblyName="$(AssemblyName)"
              PackageOutputPath="$(PackageOutputAbsolutePath)"
              IncludeSymbols="$(IncludeSymbols)"
              IncludeSource="$(IncludeSource)"
              PackageTypes="$(PackageType)"
              IsTool="$(IsTool)"
              RepositoryUrl="$(RepositoryUrl)"
              RepositoryType="$(RepositoryType)"
              RepositoryBranch="$(RepositoryBranch)"
              RepositoryCommit="$(RepositoryCommit)"
              SourceFiles="@(_SourceFiles->Distinct())"
              NoPackageAnalysis="$(NoPackageAnalysis)"
              NoDefaultExcludes="$(NoDefaultExcludes)"
              MinClientVersion="$(MinClientVersion)"
              Serviceable="$(Serviceable)"
              FrameworkAssemblyReferences="@(_FrameworkAssemblyReferences)"
              ContinuePackingAfterGeneratingNuspec="$(ContinuePackingAfterGeneratingNuspec)"
              NuspecOutputPath="$(NuspecOutputAbsolutePath)"
              IncludeBuildOutput="$(IncludeBuildOutput)"
              BuildOutputFolders="$(BuildOutputTargetFolder)"
              ContentTargetFolders="$(ContentTargetFolders)"
              RestoreOutputPath="$(RestoreOutputAbsolutePath)"
              NuspecFile="$(NuspecFileAbsolutePath)"
              NuspecBasePath="$(NuspecBasePath)"
              NuspecProperties="$(NuspecProperties)"
              AllowedOutputExtensionsInPackageBuildOutputFolder="$(AllowedOutputExtensionsInPackageBuildOutputFolder)"
              AllowedOutputExtensionsInSymbolsPackageBuildOutputFolder="$(AllowedOutputExtensionsInSymbolsPackageBuildOutputFolder)"
              NoWarn="$(NoWarn)"
              WarningsAsErrors="$(WarningsAsErrors)"
              TreatWarningsAsErrors="$(TreatWarningsAsErrors)"
              OutputFileNamesWithoutVersion="$(OutputFileNamesWithoutVersion)"
              InstallPackageToOutputPath="$(InstallPackageToOutputPath)"
              SymbolPackageFormat="$(SymbolPackageFormat)"
              PackageLicenseFile="$(PackageLicenseFile)"
              PackageLicenseExpression="$(PackageLicenseExpression)"
              PackageLicenseExpressionVersion="$(PackageLicenseExpressionVersion)"
              Deterministic="$(Deterministic)"
              PackageIcon="$(PackageIcon)"
              ContinueOnError="true"
    />
  </Target>

  <Target Name="CaravelaCompilerUpdateNuspec" DependsOnTargets="CaravelaCompilerGenerateNuspec" Condition="$(IsPackable) == 'true'">
    <ItemGroup>
      <FilteredOutput Include="@(NuGetPackOutput)" Condition="%(Extension) == '.nuspec'"/>
    </ItemGroup>

    <PropertyGroup>
      <NuspecFileAbsolutePath>@(FilteredOutput)</NuspecFileAbsolutePath>
    </PropertyGroup>

    <CaravelaCompilerRewriteNuspec NuspecFile="$(NuspecFileAbsolutePath)"/>

  </Target>

  <PropertyGroup>
    <BeforePack>$(BeforePack); CaravelaCompilerSetAnalyzerAssembliesInPackage; CaravelaCompilerUpdateNuspec</BeforePack>
  </PropertyGroup>

</Project>