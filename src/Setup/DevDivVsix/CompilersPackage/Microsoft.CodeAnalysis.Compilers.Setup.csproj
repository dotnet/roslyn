<!-- Copyright (c)  Microsoft.  All Rights Reserved.  Licensed under the Apache License, Version 2.0.  See License.txt in the project root for license information. -->
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TargetFramework>net472</TargetFramework>
    <RoslynProjectType>Custom</RoslynProjectType>
    <ApplyPartialNgenOptimization>true</ApplyPartialNgenOptimization>

    <!-- VS Insertion -->
    <TargetVsixContainerName>Microsoft.CodeAnalysis.Compilers.vsix</TargetVsixContainerName>
    <VisualStudioInsertionComponent>Microsoft.CodeAnalysis.Compilers</VisualStudioInsertionComponent>
  </PropertyGroup>

  <ItemGroup>
    <ProjectReference Include="..\..\..\Compilers\CSharp\csc\csc.csproj" PrivateAssets="All"/>
    <ProjectReference Include="..\..\..\Compilers\VisualBasic\vbc\vbc.csproj" PrivateAssets="All"/>
    <ProjectReference Include="..\..\..\Interactive\csi\csi.csproj" PrivateAssets="All"/>
    <ProjectReference Include="..\..\..\Compilers\Core\MSBuildTask\Microsoft.Build.Tasks.CodeAnalysis.csproj" PrivateAssets="All"/>
    <ProjectReference Include="..\..\..\Compilers\Server\VBCSCompiler\VBCSCompiler.csproj" PrivateAssets="All"/>
  </ItemGroup>

  <Target Name="_SetSwrFilePath">
    <PropertyGroup>
      <_SwrFilePath>$(IntermediateOutputPath)Microsoft.CodeAnalysis.Compilers.swr</_SwrFilePath>
    </PropertyGroup>
  </Target>

  <!-- 
    Calculates which external dependencies included in the target VSIX need to be updated with optimization data.
  -->
  <Target Name="_CalculateCompilerArtifactsToOptimize"
          DependsOnTargets="InitializeCompilerArtifacts">

    <ItemGroup>
      <CompilerArtifact Condition="'%(CompilerArtifact.OverwriteNgenOptimizationData)' == 'true' and '$(ApplyPartialNgenOptimization)' == 'true'">
        <_PreviousOptimizedFile>$([System.IO.Path]::Combine($(IbcOptimizationDataDir), '$([System.IO.Path]::GetFileNameWithoutExtension(%(CompilerArtifact.Identity))).pgo'))</_PreviousOptimizedFile>
        <_OptimizeAssembly>$(IntermediateOutputPath)optimized\$([System.IO.Path]::GetFileName(%(CompilerArtifact.Identity)))</_OptimizeAssembly>
      </CompilerArtifact>

      <OptimizeAssembly Include="@(CompilerArtifact->'%(_OptimizeAssembly)')"
                        PreviousOptimizedFile="%(CompilerArtifact._PreviousOptimizedFile)"
                        Condition="'%(CompilerArtifact._OptimizeAssembly)' != ''" />
    </ItemGroup>
  </Target>

  <!-- 
    Copies the artifacts that need optimization data to an intermediate output dir.
  -->
  <Target Name="_PrepareCompilerArtifactsForOptimization"
          DependsOnTargets="_CalculateCompilerArtifactsToOptimize"
          Inputs="@(CompilerArtifact)"
          Outputs="@(CompilerArtifact->'%(_OptimizeAssembly)')"
          Condition="'$(Configuration)' == 'Release' and '$(ContinuousIntegrationBuild)' == 'true' and '$(ApplyPartialNgenOptimization)' == 'true'">

    <Copy SourceFiles="%(CompilerArtifact.Identity)" DestinationFiles="%(CompilerArtifact._OptimizeAssembly)" Condition="'%(CompilerArtifact._OptimizeAssembly)' != ''">
      <Output TaskParameter="CopiedFiles" ItemName="FileWrites"/>
    </Copy>
  </Target>
  
  <Target Name="_GenerateSwrFile" 
          AfterTargets="Build"
          BeforeTargets="SwixBuild"
          DependsOnTargets="_SetSwrFilePath;InitializeCompilerArtifacts;_PrepareCompilerArtifactsForOptimization;ApplyOptimizations"
          Outputs="$(_SwrFilePath)">

    <ItemGroup>
      <_File Include="@(CompilerArtifact)">
        <Path Condition="'%(CompilerArtifact._OptimizeAssembly)' == ''">%(CompilerArtifact.Identity)</Path>
        <Path Condition="'%(CompilerArtifact._OptimizeAssembly)' != ''">%(CompilerArtifact._OptimizeAssembly)</Path>
        <NGenArchitectureString Condition="'%(CompilerArtifact.NgenArchitecture)' != ''"> vs.file.ngenArchitecture=%(CompilerArtifact.NgenArchitecture)</NGenArchitectureString>
        <NGenPriorityString Condition="'%(CompilerArtifact.NGenPriority)' != ''"> vs.file.ngenPriority=%(CompilerArtifact.NGenPriority)</NGenPriorityString>
        <NGenApplicationString Condition="'%(CompilerArtifact.NGenApplication)' != ''"> vs.file.ngenApplication="[installDir]\MSBuild\15.0\Bin\Roslyn\%(CompilerArtifact.NGenApplication)"</NGenApplicationString>
      </_File>

      <_FileEntries Include='file source="%(_File.Path)"%(_File.NGenArchitectureString)%(_File.NGenPriorityString)%(_File.NGenApplicationString)'/>

      <_CsSatellite Include="@(SatelliteAssembly)" Condition="'%(SatelliteAssembly.RecursiveDir)' == 'cs\'">
        <Path>%(SatelliteAssembly.Identity)</Path>
      </_CsSatellite>
      <_CsSatelliteEntries Include='file source="%(_CsSatellite.Path)"'/>

      <_DeSatellite Include="@(SatelliteAssembly)" Condition="'%(SatelliteAssembly.RecursiveDir)' == 'de\'">
        <Path>%(SatelliteAssembly.Identity)</Path>
      </_DeSatellite>
      <_DeSatelliteEntries Include='file source="%(_DeSatellite.Path)"'/>

      <_EsSatellite Include="@(SatelliteAssembly)" Condition="'%(SatelliteAssembly.RecursiveDir)' == 'es\'">
        <Path>%(SatelliteAssembly.Identity)</Path>
      </_EsSatellite>
      <_EsSatelliteEntries Include='file source="%(_EsSatellite.Path)"'/>

      <_FrSatellite Include="@(SatelliteAssembly)" Condition="'%(SatelliteAssembly.RecursiveDir)' == 'fr\'">
        <Path>%(SatelliteAssembly.Identity)</Path>
      </_FrSatellite>
      <_FrSatelliteEntries Include='file source="%(_FrSatellite.Path)"'/>

      <_ItSatellite Include="@(SatelliteAssembly)" Condition="'%(SatelliteAssembly.RecursiveDir)' == 'it\'">
        <Path>%(SatelliteAssembly.Identity)</Path>
      </_ItSatellite>
      <_ItSatelliteEntries Include='file source="%(_ItSatellite.Path)"'/>

      <_JaSatellite Include="@(SatelliteAssembly)" Condition="'%(SatelliteAssembly.RecursiveDir)' == 'ja\'">
        <Path>%(SatelliteAssembly.Identity)</Path>
      </_JaSatellite>
      <_JaSatelliteEntries Include='file source="%(_JaSatellite.Path)"'/>

      <_KoSatellite Include="@(SatelliteAssembly)" Condition="'%(SatelliteAssembly.RecursiveDir)' == 'ko\'">
        <Path>%(SatelliteAssembly.Identity)</Path>
      </_KoSatellite>
      <_KoSatelliteEntries Include='file source="%(_KoSatellite.Path)"'/>

      <_PlSatellite Include="@(SatelliteAssembly)" Condition="'%(SatelliteAssembly.RecursiveDir)' == 'pl\'">
        <Path>%(SatelliteAssembly.Identity)</Path>
      </_PlSatellite>
      <_PlSatelliteEntries Include='file source="%(_PlSatellite.Path)"'/>

      <_PtBrSatellite Include="@(SatelliteAssembly)" Condition="'%(SatelliteAssembly.RecursiveDir)' == 'pt-BR\'">
        <Path>%(SatelliteAssembly.Identity)</Path>
      </_PtBrSatellite>
      <_PtBrSatelliteEntries Include='file source="%(_PtBrSatellite.Path)"'/>

      <_RuSatellite Include="@(SatelliteAssembly)" Condition="'%(SatelliteAssembly.RecursiveDir)' == 'ru\'">
        <Path>%(SatelliteAssembly.Identity)</Path>
      </_RuSatellite>
      <_RuSatelliteEntries Include='file source="%(_RuSatellite.Path)"'/>

      <_TrSatellite Include="@(SatelliteAssembly)" Condition="'%(SatelliteAssembly.RecursiveDir)' == 'tr\'">
        <Path>%(SatelliteAssembly.Identity)</Path>
      </_TrSatellite>
      <_TrSatelliteEntries Include='file source="%(_TrSatellite.Path)"'/>

      <_Zh-HansSatellite Include="@(SatelliteAssembly)" Condition="'%(SatelliteAssembly.RecursiveDir)' == 'zh-Hans\'">
        <Path>%(SatelliteAssembly.Identity)</Path>
      </_Zh-HansSatellite>
      <_Zh-HansSatelliteEntries Include='file source="%(_Zh-HansSatellite.Path)"'/>

      <_Zh-HantSatellite Include="@(SatelliteAssembly)" Condition="'%(SatelliteAssembly.RecursiveDir)' == 'zh-Hant\'">
        <Path>%(SatelliteAssembly.Identity)</Path>
      </_Zh-HantSatellite>
      <_Zh-HantSatelliteEntries Include='file source="%(_Zh-HantSatellite.Path)"'/>

    </ItemGroup>

    <PropertyGroup>
      <_Lines>
        <![CDATA[use vs

package name=$(VisualStudioInsertionComponent)
        version=$(VsixVersion)

vs.dependencies
  vs.dependency id=Microsoft.Net.PackageGroup.4.7.2.Redist

vs.nonCriticalProcesses
  vs.nonCriticalProcess name="VBCSCompiler"

folder InstallDir:\MSBuild\15.0\Bin\Roslyn
  @(_FileEntries, '%0d%0a  ')

folder InstallDir:\MSBuild\15.0\Bin\Roslyn\cs
  @(_CsSatelliteEntries, '%0d%0a  ')

folder InstallDir:\MSBuild\15.0\Bin\Roslyn\de
  @(_DeSatelliteEntries, '%0d%0a  ')

folder InstallDir:\MSBuild\15.0\Bin\Roslyn\es
  @(_EsSatelliteEntries, '%0d%0a  ')

folder InstallDir:\MSBuild\15.0\Bin\Roslyn\fr
  @(_FrSatelliteEntries, '%0d%0a  ')

folder InstallDir:\MSBuild\15.0\Bin\Roslyn\it
  @(_ItSatelliteEntries, '%0d%0a  ')

folder InstallDir:\MSBuild\15.0\Bin\Roslyn\ja
  @(_JaSatelliteEntries, '%0d%0a  ')

folder InstallDir:\MSBuild\15.0\Bin\Roslyn\ko
  @(_KoSatelliteEntries, '%0d%0a  ')

folder InstallDir:\MSBuild\15.0\Bin\Roslyn\pl
  @(_PlSatelliteEntries, '%0d%0a  ')

folder InstallDir:\MSBuild\15.0\Bin\Roslyn\pt-BR
  @(_PlSatelliteEntries, '%0d%0a  ')

folder InstallDir:\MSBuild\15.0\Bin\Roslyn\ru
  @(_RuSatelliteEntries, '%0d%0a  ')

folder InstallDir:\MSBuild\15.0\Bin\Roslyn\tr
  @(_TrSatelliteEntries, '%0d%0a  ')

folder InstallDir:\MSBuild\15.0\Bin\Roslyn\zh-Hans
  @(_zh-HansSatelliteEntries, '%0d%0a  ')

folder InstallDir:\MSBuild\15.0\Bin\Roslyn\zh-Hant
  @(_zh-HantSatelliteEntries, '%0d%0a  ')

folder InstallDir:\Common7\Tools\vsdevcmd\ext
  file source="$(MSBuildProjectDirectory)\roslyn.bat"
]]>
      </_Lines>
    </PropertyGroup>
    
    <WriteLinesToFile File="$(_SwrFilePath)" Lines="$(_Lines)" Overwrite="true"/>

    <ItemGroup>
      <FileWrites Include="$(_SwrFilePath)"/>
      <SwrFile Include="$(_SwrFilePath)"/>
    </ItemGroup>
  </Target>
  
  <Import Project="..\..\..\NuGet\Microsoft.Net.Compilers\CompilerArtifacts.targets"/>
</Project>