<?xml version="1.0" encoding="utf-8"?>
<!-- Licensed to the .NET Foundation under one or more agreements. The .NET Foundation licenses this file to you under the MIT license. See the LICENSE file in the project root for more information. -->
<Project ToolsVersion="14.0" DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <Target Name="ValidateMSBuildToolsVersion" Condition="'$(BuildingProject)' == 'true'">
    <!-- The new editorconfig support requires MSBuild version 16.3. -->
    <Error Text="Microsoft.NETCore.Compilers is only supported on MSBuild v16.3 and above"
           Condition="'$(MSBuildVersion)' &lt; '16.3'" />
  </Target>

  <!-- Always use the local build task, even if we just shell out to an exe in case there are
       new properties in the local build task. -->
  <UsingTask TaskName="Microsoft.CodeAnalysis.BuildTasks.Csc"
             AssemblyFile="$(MSBuildThisFileDirectory)..\tools\Microsoft.Build.Tasks.CodeAnalysis.dll" />
  <UsingTask TaskName="Microsoft.CodeAnalysis.BuildTasks.Vbc"
             AssemblyFile="$(MSBuildThisFileDirectory)..\tools\Microsoft.Build.Tasks.CodeAnalysis.dll" />
  <UsingTask TaskName="Microsoft.CodeAnalysis.BuildTasks.CopyRefAssembly"
             AssemblyFile="$(MSBuildThisFileDirectory)..\tools\Microsoft.Build.Tasks.CodeAnalysis.dll" />

  <PropertyGroup>
    <!-- Don't use the compiler server by default in the NuGet package. -->
    <UseSharedCompilation Condition="'$(UseSharedCompilation)' == ''">false</UseSharedCompilation>
    <CSharpCoreTargetsPath>$(MSBuildThisFileDirectory)..\tools\Microsoft.CSharp.Core.targets</CSharpCoreTargetsPath>
    <VisualBasicCoreTargetsPath>$(MSBuildThisFileDirectory)..\tools\Microsoft.VisualBasic.Core.targets</VisualBasicCoreTargetsPath>
  </PropertyGroup>

  <!-- Older versions of the CLI didn't set the DOTNET_HOST_PATH variable, which
       means we have to use our shell wrappers and hope 'dotnet' is on the path. -->
  <PropertyGroup Condition="'$(DOTNET_HOST_PATH)' == ''">
    <CscToolPath>$(MSBuildThisFileDirectory)..\tools\bincore</CscToolPath>
    <CscToolExe Condition="'$(OS)' == 'Windows_NT'">RunCsc.cmd</CscToolExe>
    <CscToolExe Condition="'$(OS)' != 'Windows_NT'">RunCsc</CscToolExe>
    <VbcToolPath>$(MSBuildThisFileDirectory)..\tools\bincore</VbcToolPath>
    <VbcToolExe Condition="'$(OS)' == 'Windows_NT'">RunVbc.cmd</VbcToolExe>
    <VbcToolExe Condition="'$(OS)' != 'Windows_NT'">RunVbc</VbcToolExe>
  </PropertyGroup>

  <!-- If packaged on Windows, the RunCsc and RunVbc scripts may not be marked
       executable. If we're not running on Windows, mark them as such, just in case -->
  <Target Name="MakeCompilerScriptsExecutable"
          Condition="'$(BuildingProject)' == 'true' AND
                     '$(OS)' != 'Windows_NT' AND
                     ('$(CscToolPath)' != '' OR '$(VbcToolPath)' != '')"
          BeforeTargets="CoreCompile">
    <Exec Command="chmod +x &quot;$(CscToolPath)/$(CscToolExe)&quot; &quot;$(VbcToolPath)/$(VbcToolExe)&quot;" />
  </Target>
</Project>
