# Build on Unix
parameters:
- name: jobName
  type: string
  default: ''
- name: testArtifactName
  type: string
  default: ''
- name: configuration
  type: string
  default: 'Debug'

steps:
- template: checkout-unix-task.yml

- script:
    ./eng/build.sh
      --ci --prepareMachine --binaryLog
      --configuration ${{ parameters.configuration }}
      --solution $(Solution)
      --restore
      /p:BuildReason=$(Build.Reason)
      /p:CompilersChange=$(CompilersChange)
      /p:ScriptingChange=$(ScriptingChange)
  displayName: Restore

- script: 
    ./eng/build.sh
    --ci --prepareMachine --binaryLog
    --skipDocumentation
    --configuration ${{ parameters.configuration }}
    --solution $(Solution)
    --build
    /p:BuildReason=$(Build.Reason)
    /p:CompilersChange=$(CompilersChange)
    /p:ScriptingChange=$(ScriptingChange)
  displayName: Build

- script: ./eng/prepare-tests.sh
  displayName: Prepare Test Payload

- task: PublishPipelineArtifact@1
  displayName: Publish Test Payload
  inputs:
    targetPath: '$(Build.SourcesDirectory)/artifacts/testPayload'
    artifactName: ${{ parameters.testArtifactName }}

- template: publish-logs.yml
  parameters:
    configuration: ${{ parameters.configuration }}
    jobName: ${{ parameters.jobName }}
