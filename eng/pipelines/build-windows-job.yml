# Build on windows desktop
parameters:
  - name: jobName
    type: string
    default: ''
  - name: testArtifactName
    type: string
    default: ''
  - name: configuration
    type: string
    default: 'Debug'

steps:
- template: checkout-windows-task.yml

- task: PowerShell@2
  displayName: Restore
  inputs:
    filePath: eng/build.ps1
    arguments:
      -configuration ${{ parameters.configuration }}
      -prepareMachine -ci -binaryLog
      -msbuildEngine dotnet
      -solution $(Solution)
      -restore
      /p:BuildReason=$(Build.Reason)
      /p:CompilersChange=$(CompilersChange)
      /p:ExpressionEvaluatorChange=$(ExpressionEvaluatorChange)
      /p:ScriptingChange=$(ScriptingChange)
      /p:CodeStyleChange=$(CodeStyleChange)
      /p:WorkspaceChange= $(WorkspaceChange)
      /p:FeaturesChange=$(FeaturesChange)
      /p:VisualStudioChange=$(VisualStudioChange)
      $(RestoreArguments)

- task: PowerShell@2
  displayName: Build
  inputs:
    filePath: eng/build.ps1
    arguments:
      -configuration ${{ parameters.configuration }}
      -prepareMachine -ci -binaryLog
      -skipDocumentation
      -msbuildEngine dotnet
      -solution $(Solution)
      -build
      /p:BuildReason=$(Build.Reason)
      /p:CompilersChange=$(CompilersChange)
      /p:ExpressionEvaluatorChange=$(ExpressionEvaluatorChange)
      /p:ScriptingChange=$(ScriptingChange)
      /p:CodeStyleChange=$(CodeStyleChange)
      /p:WorkspaceChange= $(WorkspaceChange)
      /p:FeaturesChange=$(FeaturesChange)
      /p:VisualStudioChange=$(VisualStudioChange)
      $(BuildArguments)

- task: PowerShell@2
  displayName: Prepare Unit Tests
  inputs:
    filePath: eng/prepare-tests.ps1
    arguments: -configuration ${{ parameters.configuration }}
  condition: and(ne(variables['ArtifactName'], ''), succeeded())

- task: PublishPipelineArtifact@1
  displayName: Publish Test Payload
  inputs:
    targetPath: '$(Build.SourcesDirectory)\artifacts\testPayload'
    artifactName: ${{ parameters.testArtifactName }}
  condition: and(ne(variables['ArtifactName'], ''), succeeded())

- template: publish-logs.yml
  parameters:
    configuration: ${{ parameters.configuration }}
    jobName: ${{ parameters.jobName }}

