trigger: none # We only want to trigger manually or based on resources
pr: none

resources:
  repositories:
  - repository: MicroBuildTemplate
    type: git
    name: 1ESPipelineTemplates/MicroBuildTemplate
    ref: refs/tags/release
  pipelines:
  - pipeline: CI
    source: Library # TODO: This should match the name of your CI pipeline
    tags:
    - Real signed
    trigger:
      tags:
      - Real signed
      - auto-insertion

extends:
  template: azure-pipelines/MicroBuild.1ES.Official.yml@MicroBuildTemplate
  parameters:
    sdl:
      sourceAnalysisPool: VSEngSS-MicroBuild2022-1ES

    stages:
    - stage: insertion
      jobs:
      - job: insertion
        displayName: VS insertion
        pool: VSEngSS-MicroBuild2022-1ES
        steps:
        - checkout: none
        - powershell: Write-Host "##vso[build.updatebuildnumber]$(resources.pipeline.CI.runName)"
          displayName: ‚öôÔ∏è Set pipeline name
        - task: UseDotNet@2
          displayName: ‚öôÔ∏è Install .NET SDK
          inputs:
            packageType: sdk
            version: 6.x
        - task: NuGetAuthenticate@1
          displayName: üîè Authenticate NuGet feeds
          inputs:
            forceReinstallCredentialProvider: true
        - template: azure-pipelines/release-deployment-prep.yml@self
        - download: CI
          artifact: VSInsertion-Windows
          displayName: üîª Download VSInsertion-Windows artifact
        - script: dotnet nuget push $(Pipeline.Workspace)\CI\VSInsertion-windows\*.nupkg -s https://pkgs.dev.azure.com/devdiv/_packaging/VS/nuget/v3/index.json -k azdo --skip-duplicate
          displayName: üì¶ Push CoreXT packages to VS feed
        - task: MicroBuildInsertVsPayload@4
          displayName: üè≠ Insert VS Payload
          inputs:
            TeamName: $(TeamName)
            TeamEmail: $(TeamEmail)
            InsertionPayloadName: $(Build.Repository.Name) $(Build.BuildNumber)
            InsertionBuildPolicy: Request Perf DDRITs
            AutoCompletePR: true
            AutoCompleteMergeStrategy: Squash
        - powershell: |
            $contentType = 'application/json';
            $headers = @{ Authorization = 'Bearer $(System.AccessToken)' };
            $rawRequest = @{ daysValid = 365 * 2; definitionId = $(resources.pipeline.CI.pipelineID); ownerId = 'User:$(Build.RequestedForId)'; protectPipeline = $false; runId = $(resources.pipeline.CI.runId) };
            $request = ConvertTo-Json @($rawRequest);
            Write-Host $request
            $uri = "$(System.CollectionUri)$(System.TeamProject)/_apis/build/retention/leases?api-version=6.0-preview.1";
            Invoke-RestMethod -uri $uri -method POST -Headers $headers -ContentType $contentType -Body $request;
          displayName: üóª Retain inserted builds
